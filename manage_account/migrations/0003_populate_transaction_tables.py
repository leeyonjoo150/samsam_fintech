# Generated by Django 5.2.5 on 2025-09-15 02:40
# manage_account/migrations/0003_populate_transaction_tables.py
# ìˆ˜ë§ì€ ê³ ìƒëì— ì™„ì„±í•œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì´ë‹¤.
# models.pyì— ì •ì˜ëœ ìƒˆë¡œìš´ ëª¨ë¸ì˜ í•„ë“œì™€ ê¸°ì¡´ ëª¨ë¸ì˜ ë°ì´í„° typeì´ ë‹¤ë¥´ë©´ ë¬¸ì œê°€ ë§ìœ¼ë‹ˆ ì²˜ìŒë¶€í„° ì‹ ì¤‘íˆ ê³ ë ¤í•˜ì—¬ ë””ìì¸ í•´ì•¼í•œë‹¤
# íŠ¹íˆ, ('txn_date', models.DateTimeField(auto_now_add=True, verbose_name='ê±°ë˜ë‚ ì§œ')), 
#                                        auto_now_add=Trueë¡œ ì„¤ì •í•˜ë©´ ê°ì²´ ìƒì„± ì‹œì ì˜ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë˜ì–´, ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ì›í•˜ëŠ” ë‚ ì§œë¡œ ì„¤ì •í•  ìˆ˜ ì—†ë‹¤.
#
from django.db import migrations
from django.db.migrations import SeparateDatabaseAndState # ì´ ì¤„ì„ ì¶”ê°€
# from django.contrib.auth.models import User
from decimal import Decimal
from datetime import datetime, time  # datetime ëª¨ë“ˆ ì¶”ê°€
from django.utils import timezone  # timezone ëª¨ë“ˆ ì¶”ê°€
import pytz  # pytz ëª¨ë“ˆ ì¶”ê°€


# ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìœ„í•œ í•¨ìˆ˜
def populate_data(apps, schema_editor):
    # ì‚¬ìš©í•  íƒ€ì„ì¡´ì„ ì„¤ì •í•©ë‹ˆë‹¤. (settings.pyì˜ TIME_ZONEê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸)
    tz_korea = pytz.timezone('Asia/Seoul')
    
    # Old model ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    OldTransaction = apps.get_model('dashboard', 'Transaction')
    
    # New models ê°€ì ¸ì˜¤ê¸° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    Account = apps.get_model('manage_account', 'Account')
    AccountBookCategory = apps.get_model('manage_account', 'AccountBookCategory')
    TransactionAccount = apps.get_model('manage_account', 'TransactionAccount')
    
    # ì‚¬ìš©ì ëª¨ë¸ì„ í”„ë¡œì íŠ¸ ì„¤ì •ì— ë§ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    # ê¸°ì¡´ ì½”ë“œ: from django.contrib.auth.models import User
    # ë³€ê²½ ì½”ë“œ: apps.get_model('acc_auth', 'User')
    User = apps.get_model('acc_auth', 'User')

    # 'hl5buj' ì‚¬ìš©ì ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    try:
        user_instance = User.objects.get(user_name='hl5buj')
    except User.DoesNotExist:
        print("Warning: 'hl5buj' does not exist. Please check the username.")
        return 

    # hl5bujì˜ ê³„ì¢Œë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±í•©ë‹ˆë‹¤.
    account_instance, created = Account.objects.get_or_create(
        acc_user_name=user_instance,
        acc_bank="KBêµ­ë¯¼ì€í–‰",
        defaults={'acc_num': '123-45-67890', 'acc_pw': '1234'}
    )
    if created:
        print("Created new dummy account.")
    else:
        print("Using existing dummy account.")

    # 2. manage_account_accountbookcategory í…Œì´ë¸”ì— ë°ì´í„° ë³µì‚¬
    # ê¸°ì¡´ Transaction í…Œì´ë¸”ì˜ categoryë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¤‘ë³µ ì—†ì´ Category ìƒì„±
    categories = OldTransaction.objects.values_list('category', flat=True).distinct()
    category_map = {}
    for cat_name in categories:
        category_obj, _ = AccountBookCategory.objects.get_or_create(
            cat_type=cat_name
        )
        category_map[cat_name] = category_obj
    print(f"Created {len(categories)} unique categories.")

    # ğŸƒâ€â™‚ï¸ running_balance ë³€ìˆ˜ë¥¼ ì—¬ê¸°ì„œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
    running_balance = Decimal('0.00')

    # ëª¨ë“  ê±°ë˜ë¥¼ ë‚ ì§œ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì ¸ì˜¤ê¸°
    all_transactions = OldTransaction.objects.order_by('transaction_date')
    
    # ì¼ê´„ ìƒì„±ì„ ìœ„í•œ ë¦¬ìŠ¤íŠ¸
    transactions_to_create = []

    for old_trans in all_transactions:
        # ê±°ë˜ ìœ í˜•ì— ë”°ë¼ ì”ì•¡ì„ ê³„ì‚°
        if old_trans.transaction_type == 'ìˆ˜ì…': # 'ìˆ˜ì…' í•„ë“œ ê°’ì´ 'ìˆ˜ì…'ì¸ì§€ í™•ì¸
            running_balance += old_trans.amount
        elif old_trans.transaction_type == 'ì§€ì¶œ': # 'ì§€ì¶œ' í•„ë“œ ê°’ì´ 'ì§€ì¶œ'ì¸ì§€ í™•ì¸
            running_balance -= old_trans.amount
        
        category = None
        if old_trans.category:
            try:
                category = AccountBookCategory.objects.get(
                    # user=user_instance,
                    cat_type=old_trans.category
                )
            except AccountBookCategory.DoesNotExist:
                pass
        # Naive datetime ê°ì²´ë¥¼ Awareí•˜ê²Œ ë³€í™˜
        # Naive datetime ê°ì²´ë¥¼ Awareí•˜ê²Œ ë³€í™˜
        # ê¸°ì¡´ ì½”ë“œ: aware_date = timezone.make_aware(datetime.combine(old_trans.transaction_date, datetime.min.time()))
        # ìˆ˜ì • ì½”ë“œ:
        naive_dt = datetime.combine(old_trans.transaction_date, time(12, 0, 0))
        aware_date = tz_korea.localize(naive_dt, is_dst=False)
                
        # TransactionAccount ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        new_trans = TransactionAccount(
            my_acc=account_instance,
            txn_side=old_trans.transaction_type,
            txn_date=aware_date,  # ë³€í™˜ëœ ë‚ ì§œ ê°ì²´ ì‚¬ìš©
            txn_amount=Decimal(old_trans.amount),
            txn_balance=running_balance,
            txn_cat=category,
            txn_cont=old_trans.description,
            cpart_acc=None
        )
        transactions_to_create.append(new_trans)
   
    # bulk_createë¥¼ ì‚¬ìš©í•˜ì—¬ ORMì˜ ìë™í™”ëœ ë™ì‘ì„ ìš°íšŒ
    # ì´ëŠ” auto_now_add=True ì˜µì…˜ì„ ë¬´ì‹œí•˜ê³  ê°’ì„ ê°•ì œë¡œ ë„£ì„ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.
    TransactionAccount.objects.bulk_create(transactions_to_create)
    print(f"Migrated {len(transactions_to_create)} transactions.")    
        
    #     TransactionAccount.objects.create(
    #         my_acc=account_instance,
    #         txn_side=old_trans.transaction_type,
    #         txn_date=old_trans.transaction_date,
    #         txn_amount=Decimal(old_trans.amount),
    #         # ê³„ì‚°ëœ ì”ì•¡ì„ ì „ë‹¬
    #         txn_balance=running_balance,
    #         txn_cat=category,
    #         txn_cont=old_trans.description,
    #         # cpart_accëŠ” Noneìœ¼ë¡œ ë‘ëŠ” ì´ì „ ì½”ë“œê°€ ë§ìŠµë‹ˆë‹¤.
    #         cpart_acc=None
    #     )
    # print(f"Migrated {all_transactions.count()} transactions.")

def reverse_populate_data(apps, schema_editor):
    """
    ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ë˜ëŒë¦´ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜.
    ìƒˆë¡­ê²Œ ìƒì„±ëœ ëª¨ë“  TransactionAccountì™€ AccountBookCategory ê°ì²´ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
    """
    TransactionAccount = apps.get_model('manage_account', 'TransactionAccount')
    AccountBookCategory = apps.get_model('manage_account', 'AccountBookCategory')

    # ìƒì„±ëœ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.
    TransactionAccount.objects.all().delete()
    AccountBookCategory.objects.all().delete()
    

class Migration(migrations.Migration):

    dependencies = [
        # ë‹¤ë¥¸ ì•±ì˜ ëª¨ë¸ì„ ì°¸ì¡°í•˜ë¯€ë¡œ í•´ë‹¹ ì•±ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ì— ì˜ì¡´ì„±ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
        ('acc_auth', '0001_initial'),
        ('dashboard', '0001_initial'), # dashboard ì•±ì˜ ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
        ('manage_account', '0005_alter_transactionaccount_cpart_acc'), # manage_account ì•±ì˜ ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
        # ë§Œì•½ User ëª¨ë¸ì„ ì‚¬ìš©í•œë‹¤ë©´ auth ì•±ë„ í•„ìš”
    ]

    operations = [
        # ë°ì´í„°ë² ì´ìŠ¤ì™€ ëª¨ë¸ ìƒíƒœë¥¼ ë¶„ë¦¬í•˜ì—¬ RunPython ì‹¤í–‰
        SeparateDatabaseAndState(
            state_operations=[], # ìƒíƒœ ë³€ê²½ ì—†ìŒ
            database_operations=[ # ë°ì´í„°ë² ì´ìŠ¤ì— ì§ì ‘ ì˜í–¥ì„ ì£¼ëŠ” ì‘ì—…
                migrations.RunPython(populate_data, reverse_populate_data),
            ]
        ),
    ]