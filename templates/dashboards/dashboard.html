{% extends 'common/base.html' %}
{% load humanize %}


{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
    /* 
    ==========================================================================
    수정: 2025/09/12 by sskim
    base.html 'static/css/custom.css'에 등록된 style 내용과 중복되는 부분 주석 처리
    =====
    body {
        background-color: #67b2ecff;
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        color: #333;
    }
    ==========================================================================
    container-fluid style은 base.html에 정의한 style과 중복되어 두께가 2배로 나와서 주석 처리
    =====
    .container-fluid {
        padding: 2.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    ========================================================================== 
    */

    .dashboard-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        border-left: 6px solid #007bff;
        padding-left: 1.5rem;
        margin-bottom: 2.5rem;
        line-height: 1.2;
    }
    .card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        background-color: #fff;
    }
    .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    .card-header {
        font-weight: 600;
        font-size: 1.2rem;
        color: #495057;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        padding: 1.25rem 1.5rem;
    }
    .card-body {
        padding: 1.5rem;
    }
    .metric-card .card-body {
        text-align: center;
    }
    .metric-card p {
        font-size: 1rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .metric-card h3 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0;
    }
    .income-text {
        color: #28a745 !important; /* 초록색, 우선순위 강제 적용 */
    }
    .expense-text {
        color: #dc3545 !important; /* 빨간색, 우선순위 강제 적용 */
    }
    .balance-text {
        color: #007bff !important; /* 파란색, 우선순위 강제 적용 */
    }
    .chart-container {
        height: 380px;
        width: 100%;
        position: relative;
    }
    .table th {
        font-weight: 600;
        color: #495057;
        background-color: #f8f9fa;
    }
    .table-responsive {
        overflow-x: auto;
    }
    .text-right {
        text-align: right;
    }
</style>


<div class="container-fluid">
    <h1 class="dashboard-title">삼삼핀테크 대시보드</h1>

    <div class="card mb-4 p-4">
        <div class="row align-items-center">
            <div class="col-md-auto mb-2 mb-md-0">
                <label for="startDate">시작일:</label>
                <input type="date" id="startDate" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-auto mb-2 mb-md-0">
                <label for="endDate">종료일:</label>
                <input type="date" id="endDate" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-auto">
                <button id="filterBtn" class="btn btn-primary mt-3">조회</button>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="card metric-card">
                <div class="card-header border-0 pb-0">
                    기간 수입 합계
                    <p class="m-0 text-muted" style="font-size: 0.9rem;">
                        {{ start_date }} ~ {{ end_date }}
                    </p>
                </div>
                <div class="card-body pt-2">
                    <h3 class="income-text">{{ total_income|floatformat:"0"|intcomma }}원</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6 col-sm-12">
            <div class="card metric-card">
                <div class="card-header border-0 pb-0">
                    기간 지출 합계
                    <p class="m-0 text-muted" style="font-size: 0.9rem;">
                        {{ start_date }} ~ {{ end_date }}
                    </p>
                </div>
                <div class="card-body pt-2">
                    <h3 class="expense-text">{{ total_expense|floatformat:"0"|intcomma }}원</h3>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-12 col-sm-12">
            <div class="card metric-card">
                <div class="card-header border-0 pb-0">
                    기간 잔액 합계
                    <p class="m-0 text-muted" style="font-size: 0.9rem;">
                        {{ end_date }} 기준
                    </p>
                </div>
                <div class="card-body pt-2">
                    <h3 class="balance-text">{{ net_balance|floatformat:"0"|intcomma }}원</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-6 col-md-12">
            <div class="card">
                <div class="card-header">카테고리별 지출</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-12">
            <div class="card">
                <div class="card-header">월별 수입/지출 추이</div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6 col-md-12">
            <div class="card">
                <div class="card-header">수입 내역</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="incomeTable">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>카테고리</th>
                                    <th>내역</th>
                                    <th class="text-right">금액</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-right"><strong>총 수입:</strong></td>
                                    <td class="text-right income-text"><strong>{{ total_income|floatformat:"0"|intcomma }}원</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 col-md-12">
            <div class="card">
                <div class="card-header">지출 내역</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="expenseTable">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>카테고리</th>
                                    <th>내역</th>
                                    <th class="text-right">금액</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" class="text-right"><strong>총 지출:</strong></td>
                                    <td class="text-right expense-text"><strong>{{ total_expense|floatformat:"0"|intcomma }}원</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart.js Datalabels 플러그인 등록
        Chart.register(ChartDataLabels);

        let recentIncomeTransactions = [];
        let recentExpenseTransactions = [];
        let expenseData = [];
        let monthlyData = [];

        // 데이터 파싱
        try {
            recentIncomeTransactions = JSON.parse('{{ recent_income_transactions|safe|escapejs }}');
            recentExpenseTransactions = JSON.parse('{{ recent_expense_transactions|safe|escapejs }}');
            expenseData = JSON.parse('{{ expense_by_category|safe|escapejs }}');
            monthlyData = JSON.parse('{{ transactions_by_month|safe|escapejs }}');
        } catch (e) {
            console.error("데이터 파싱 오류:", e);
            console.error("수입 데이터:", '{{ recent_income_transactions|safe|escapejs }}');
            console.error("지출 데이터:", '{{ recent_expense_transactions|safe|escapejs }}');
            console.error("카테고리별 지출 데이터:", '{{ expense_by_category|safe|escapejs }}');
            console.error("월별 데이터:", '{{ transactions_by_month|safe|escapejs }}');
        }

        // 1. 거래 내역 테이블 분할 및 채우기
        function populateTable(tableId, data) {
            const tableBody = document.querySelector(tableId + ' tbody');
            if (tableBody) {
                tableBody.innerHTML = '';
                if (Array.isArray(data)) {
                    data.forEach(tx => {
                        const row = document.createElement('tr');
                        const amountFormatted = Number(tx.amount).toLocaleString('ko-KR');
                        row.innerHTML = `
                            <td>${tx.transaction_date}</td>
                            <td>${tx.category}</td>
                            <td>${tx.description}</td>
                            <td class="text-right">${amountFormatted}원</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            }
        }

        populateTable('#incomeTable', recentIncomeTransactions);
        populateTable('#expenseTable', recentExpenseTransactions);

        // 2. 파이 차트 (비율 표시 기능 추가)
        const expenseCtx = document.getElementById('expenseChart');
        if (expenseCtx && Array.isArray(expenseData) && expenseData.length > 0) {
            const totalExpense = expenseData.reduce((sum, d) => sum + d.total, 0);
            new Chart(expenseCtx, {
                type: 'pie',
                data: {
                    labels: expenseData.map(d => d.category),
                    datasets: [{
                        data: expenseData.map(d => d.total),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#f8f9fc']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const total = context.parsed;
                                    const percentage = ((total / totalExpense) * 100).toFixed(1);
                                    return `${label}: ${total.toLocaleString('ko-KR')}원 (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((sum, d) => sum + d, 0);
                                const percentage = ((value / total) * 100).toFixed(1) + '%';
                                return percentage;
                            },
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        // 3. 월별 추이 막대 그래프
        const monthlyCtx = document.getElementById('monthlyChart');
        if (monthlyCtx && Array.isArray(monthlyData) && monthlyData.length > 0) {
            const months = [...new Set(monthlyData.map(d => d.month))].sort();
            const incomeSeries = months.map(month => {
                const item = monthlyData.find(d => d.month === month && d.transaction_type === '수입');
                return item ? item.total : 0;
            });
            const expenseSeries = months.map(month => {
                const item = monthlyData.find(d => d.month === month && d.transaction_type === '지출');
                return item ? item.total : 0;
            });

            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '수입',
                        data: incomeSeries,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)'
                    }, {
                        label: '지출',
                        data: expenseSeries,
                        backgroundColor: 'rgba(220, 53, 69, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: '금액 (원)' }
                        },
                        x: {
                            title: { display: true, text: '월' },
                            // 레이블을 'YYYY-MM' 형식으로 포맷
                        }
                    }
                }
            });
        }

        // 날짜 필터링 버튼 이벤트
        document.getElementById('filterBtn').addEventListener('click', function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const url = `/dashboard/?start_date=${startDate}&end_date=${endDate}`;
            window.location.href = url;
        });
    });
</script>
{% endblock %}