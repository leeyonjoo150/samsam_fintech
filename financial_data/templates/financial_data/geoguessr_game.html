{% extends 'common/base.html' %}
{% block content %}
<div class="container text-center mt-5">
    <h1>어디일까요?</h1>
    <p class="lead">아래 사진을 보고 지도에서 위치를 추측해 보세요!</p>
</div>

<div class="container">
    <div id="correct-answer-section" class="card mt-5 d-none">
        <img id="location-image" src="" class="card-img-top" alt="정답 장소 사진">
        <div class="card-body text-center">
            <h2 id="location-name" class="card-title"></h2>
            <p id="location-description" class="card-text"></p>
        </div>
    </div>
    
    <div id="result" class="mt-3"></div>

</div>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div id="panorama" style="height: 500px;"></div>
        </div>
        <div class="col-md-6 mb-4">
            <div id="map" style="height: 500px;"></div>
        </div>
    </div>
    <div class="text-center mt-3">
        <button id="guess-button" class="pretty-button">여기야! (정답 제출)</button>
    </div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=geometry"></script>
<script>
    function initMap() {
        const startLocation = { lat: parseFloat("{{ start_location.lat }}"), lng: parseFloat("{{ start_location.lng }}") };
        const locationName = "{{ start_location.name }}";
        const locationDescription = "{{ start_location.description }}";
        const locationImage = "{{ start_location.image_url }}";

        // 1. Street View 설정
        const panorama = new google.maps.StreetViewPanorama(
            document.getElementById("panorama"),
            {
                position: startLocation,
                pov: { heading: 165, pitch: 0 },
                zoom: 1,
                linksControl: false,
                panControl: false,
                fullscreenControl: false,
            }
        );

        // 2. 추측용 지도 설정
        const map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 0, lng: 0 },
            zoom: 2,
            streetViewControl: false,
        });

        let guessMarker = null;

        map.addListener("click", (e) => {
            if (guessMarker) {
                guessMarker.setMap(null); // 기존 마커 제거
            }
            guessMarker = new google.maps.Marker({
                position: e.latLng,
                map: map,
                title: "내 추측",
            });
        });

        // 3. 게임 로직
        document.getElementById("guess-button").addEventListener("click", () => {
            if (!guessMarker) {
                alert("지도에 위치를 추측해 주세요.");
                return;
            }

            const actualLocation = new google.maps.LatLng(startLocation.lat, startLocation.lng);
            const guessedLocation = guessMarker.getPosition();

            // 거리 계산 (미터 단위)
            const distance = google.maps.geometry.spherical.computeDistanceBetween(actualLocation, guessedLocation);

            const resultDiv = document.getElementById("result");
            const correctSection = document.getElementById("correct-answer-section");

            // 100m 이내인지 확인
            if (distance <= 100) {
                // 정답 처리
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>정답입니다!</strong> 100m 이내로 정확하게 맞추셨어요!
                    </div>
                `;
                correctSection.classList.remove('d-none'); // 정답 섹션 표시
                document.getElementById('location-image').src = locationImage;
                document.getElementById('location-name').innerText = locationName;
                document.getElementById('location-description').innerText = locationDescription;
            }
            else if (distance <= 300) {
                // 정답 처리
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>정답입니다!</strong> 300m 이내로 근접하게 맞추셨어요!
                    </div>
                `;
                correctSection.classList.remove('d-none'); // 정답 섹션 표시
                document.getElementById('location-image').src = locationImage;
                document.getElementById('location-name').innerText = locationName;
                document.getElementById('location-description').innerText = locationDescription;
                }
            else {
                // 오답 처리
                const distanceKm = (distance / 1000).toFixed(2);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        아쉽네요. 정답과 ${distanceKm} km 떨어져 있습니다.
                    </div>
                `;
            }

            // 정답 위치에 마커와 선 표시
            new google.maps.Marker({
                position: actualLocation,
                map: map,
                title: "정답",
                icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
            });
            const line = new google.maps.Polyline({
                path: [guessedLocation, actualLocation],
                geodesic: true,
                strokeColor: "#FF0000",
                strokeOpacity: 1.0,
                strokeWeight: 2,
            });
            line.setMap(map);
        });
    }

    // 페이지 로드 시 맵 초기화
    window.onload = initMap;
</script>
{% endblock %}